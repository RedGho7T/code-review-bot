# Настройки AI review bot
telegram:
  enabled: true
  bot-token: ${TELEGRAM_BOT_TOKEN:}
  bot-username: ${TELEGRAM_BOT_USERNAME:}
  channel-id: ${TELEGRAM_CHANNEL_ID}
  broadcast:
    fixed-rate-ms: 5000

code-review:
  # --- Основное управление ---
  enabled: true               # глобально включить/выключить бота
  dry-run: false              # true = ничего не публикуем в GitLab (только тест)
  projectIds: [ 24 ]          # список projectId, где бот активен

  # --- RAG (контекст код-стандартов) ---
  rag-enabled: true          # включить/выключить RAG

  # --- Ограничения анализа / размер промпта ---
  max-files-per-review: 20
  max-lines-per-file: 500
  max-diff-chars-per-file: 12000
  max-diff-chars-total: 60000
  max-prompt-chars-total: 85000

  # --- Inline комментарии (по строкам diff) ---
  inline-enabled: true
  max-inline-comments: 10
  max-inline-comments-per-file: 3
  max-inline-comment-chars: 1200
  inline-publish-delay-ms: 200

  # --- Scheduler (polling Merge Requests) ---
  scheduler-enabled: false
  scheduler-cron: "0 */15 * * * *"
  scheduler-lookback-minutes: 30
  scheduler-per-project-limit: 10

  # --- Служебные статус-комментарии ---
  status-comments-enabled: false


# GitLab
gitlab:
  api:
    url: "${GITLAB_API_URL:}"
    token: "${GITLAB_API_TOKEN:}"
  webhook:
    secret: "${GITLAB_WEBHOOK_SECRET:}"


# ChromaDB + RAG настройки
chroma:
  url: "${CHROMA_URL:http://localhost:8000}"
  top-k: 5
  similarity-threshold: 0.4

  # --- Ограничения RAG-контекста ---
  max-rag-chars-total: 8000
  max-rag-chars-per-doc: 1500
  max-rag-docs-per-source: 2
  max-rag-sources: 3
  rag-max-context-chars-total: 12000
  rag-max-context-chars-general: 4500
  rag-max-context-chars-per-file: 1500
  rag-top-files: 5
  rag-economy-mode: true
  # --- Ограничение входа для embeddings ---
  max-embedding-query-chars: 15000
  # --- Индексация RAG документов при старте ---
  indexing-enabled: true


# Spring / инфраструктура
spring:
  ai: # Настройка конфигурации AI
    retry:
      max-attempts: 1 # Ретрай в рамках Open AI
    openai:
      api-key: ${OPENAI_API_KEY}
      chat:
        options:
          model: ${OPENAI_MODEL:gpt-4o-mini}
          temperature: 0.3
      embedding:
        options:
          model: text-embedding-3-small
  config:
    import: "optional:file:./.env.properties"


  datasource:
    url: "${DB_URL:jdbc:postgresql://localhost:5432/review_bot}"
    username: "${DB_USER:review_bot}"
    password: "${DB_PASSWORD:review_bot}"
    driver-class-name: org.postgresql.Driver

  jpa:
    hibernate:
      ddl-auto: validate
    properties:
      hibernate:
        dialect:

  flyway:
    enabled: true
    locations: classpath:db/migration


# Логи (для отладки RAG/AI)
logging:
  level:
    org.springframework.ai: DEBUG
    com.groviate.telegramcodereviewbot.service: DEBUG
    org.hibernate: INFO
    org.springframework.boot.autoconfigure.jdbc: DEBUG
    org.springframework.orm.jpa: DEBUG
    org.springframework.ai.retry.autoconfigure: ERROR

# Настройки Spring Boot Actuator: какие endpoints доступны, health-детали и т.п.
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus,circuitbreakers,circuitbreakerevents,retries,retryevents
  endpoint:
    health:
      show-details: always

# Настройка повторных попыток при сбоях
resilience4j:
  retry:
    instances:
      openai:
        max-attempts: 3
        wait-duration: 500ms
      gitlab:
        max-attempts: 2
        wait-duration: 300ms
  circuitbreaker:
    instances:
      openai:
        sliding-window-type: COUNT_BASED
        sliding-window-size: 20
        minimum-number-of-calls: 10
        failure-rate-threshold: 50
        permitted-number-of-calls-in-half-open-state: 5
        wait-duration-in-open-state: 30s
        ignore-exceptions:
          - com.groviate.telegramcodereviewbot.exception.AiNonRetryableException